services:
  postgres:
    image: postgres:15-alpine
    container_name: secondlayer-postgres
    environment:
      POSTGRES_USER: secondlayer
      POSTGRES_PASSWORD: secondlayer_password
      POSTGRES_DB: secondlayer_db
    command:
      - "postgres"
      - "-c"
      - "log_statement=all"
      - "-c"
      - "log_duration=on"
      - "-c"
      - "log_connections=on"
      - "-c"
      - "log_disconnections=on"
      - "-c"
      - "log_error_verbosity=verbose"
      - "-c"
      - "log_min_duration_statement=0"
      - "-c"
      - "log_line_prefix=%t [%p] %u@%d "
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./src/database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U secondlayer -d secondlayer_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  qdrant:
    build:
      context: .
      dockerfile: Dockerfile.qdrant
    container_name: secondlayer-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  redis:
    image: redis:7-alpine
    container_name: secondlayer-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  app:
    build:
      context: ..
      dockerfile: Dockerfile.mono-backend
    container_name: secondlayer-app
    environment:
      NODE_ENV: production
      # Database connection
      DATABASE_URL: postgresql://secondlayer:secondlayer_password@postgres:5432/secondlayer_db
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: secondlayer
      POSTGRES_PASSWORD: secondlayer_password
      POSTGRES_DB: secondlayer_db
      # Vector DB and Cache
      QDRANT_URL: http://qdrant:6333
      REDIS_URL: redis://redis:6379
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # OpenAI Configuration
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_API_KEY2: ${OPENAI_API_KEY2:-}
      OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-ada-002}
      # Dynamic model selection - OpenAI (recommended)
      OPENAI_MODEL_QUICK: ${OPENAI_MODEL_QUICK:-gpt-4o-mini}
      OPENAI_MODEL_STANDARD: ${OPENAI_MODEL_STANDARD:-gpt-4o-mini}
      OPENAI_MODEL_DEEP: ${OPENAI_MODEL_DEEP:-gpt-4o}
      # OR single model for all tasks (backward compatibility)
      # OPENAI_MODEL: ${OPENAI_MODEL:-}
      # Anthropic/Claude Configuration
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_API_KEY2: ${ANTHROPIC_API_KEY2:-}
      # Dynamic model selection - Anthropic
      ANTHROPIC_MODEL_QUICK: ${ANTHROPIC_MODEL_QUICK:-claude-haiku-4.5}
      ANTHROPIC_MODEL_STANDARD: ${ANTHROPIC_MODEL_STANDARD:-claude-sonnet-4.5}
      ANTHROPIC_MODEL_DEEP: ${ANTHROPIC_MODEL_DEEP:-claude-opus-4.5}
      # Provider selection strategy: "openai-first" (default), "anthropic-first", "round-robin", "cheapest"
      LLM_PROVIDER_STRATEGY: ${LLM_PROVIDER_STRATEGY:-openai-first}
      # ZakonOnline API
      ZAKONONLINE_API_TOKEN: ${ZAKONONLINE_API_TOKEN}
      ZAKONONLINE_API_TOKEN2: ${ZAKONONLINE_API_TOKEN2:-}
      # HTTP Server
      SECONDARY_LAYER_KEYS: ${SECONDARY_LAYER_KEYS:-test-key-123}
      HTTP_PORT: 3000
      HTTP_HOST: 0.0.0.0
      PORT: 3000
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
      redis:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped

volumes:
  postgres_data:
  qdrant_data:
  redis_data:
