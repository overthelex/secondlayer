/**
 * Payment Routes
 * Handles payment creation and webhook callbacks
 */

import { Router, Request, Response } from 'express';
import { StripeService } from '../services/stripe-service.js';
import { FondyService } from '../services/fondy-service.js';
import { MockStripeService } from '../services/__mocks__/stripe-service-mock.js';
import { MockFondyService } from '../services/__mocks__/fondy-service-mock.js';
import { logger } from '../utils/logger.js';

/**
 * Create payment router
 */
export function createPaymentRouter(
  stripeService: StripeService | MockStripeService,
  fondyService: FondyService | MockFondyService
): Router {
  const router = Router();

  /**
   * @route   POST /api/billing/payment/stripe/create
   * @desc    Create Stripe PaymentIntent
   * @access  Protected (JWT required)
   */
  router.post('/stripe/create', async (req: any, res: Response) => {
    try {
      const userId = req.user.userId;
      const email = req.user.email;
      const { amount_usd, metadata } = req.body;

      if (!amount_usd || typeof amount_usd !== 'number') {
        return res.status(400).json({
          error: 'Invalid request',
          message: 'amount_usd is required and must be a number',
        });
      }

      const result = await stripeService.createPaymentIntent(
        userId,
        amount_usd,
        email,
        metadata
      );

      res.json(result);
    } catch (error: any) {
      logger.error('Failed to create Stripe payment', {
        error: error.message,
      });
      return res.status(500).json({
        error: 'Payment creation failed',
        message: error.message,
      });
    }
  });

  /**
   * @route   POST /api/billing/payment/fondy/create
   * @desc    Create Fondy payment
   * @access  Protected (JWT required)
   */
  router.post('/fondy/create', async (req: any, res: Response) => {
    try {
      const userId = req.user.userId;
      const email = req.user.email;
      const { amount_uah } = req.body;

      if (!amount_uah || typeof amount_uah !== 'number') {
        return res.status(400).json({
          error: 'Invalid request',
          message: 'amount_uah is required and must be a number',
        });
      }

      // Generate unique order ID
      const orderId = `SL-${userId.substring(0, 8)}-${Date.now()}`;
      const description = `SecondLayer balance top-up: ${amount_uah} UAH`;

      const result = await fondyService.createPayment(
        userId,
        amount_uah,
        email,
        orderId,
        description
      );

      res.json(result);
    } catch (error: any) {
      logger.error('Failed to create Fondy payment', {
        error: error.message,
      });
      return res.status(500).json({
        error: 'Payment creation failed',
        message: error.message,
      });
    }
  });

  /**
   * @route   GET /api/billing/payment/:provider/:paymentId/status
   * @desc    Get payment status
   * @access  Protected (JWT required)
   */
  router.get('/:provider/:paymentId/status', async (req: any, res: Response) => {
    try {
      const { provider, paymentId } = req.params;

      let status;
      if (provider === 'stripe') {
        status = await stripeService.getPaymentStatus(paymentId);
      } else if (provider === 'fondy') {
        status = await fondyService.getPaymentStatus(paymentId);
      } else {
        return res.status(400).json({
          error: 'Invalid provider',
          message: 'Provider must be stripe or fondy',
        });
      }

      res.json(status);
    } catch (error: any) {
      logger.error('Failed to get payment status', {
        error: error.message,
      });
      return res.status(500).json({
        error: 'Failed to get payment status',
        message: error.message,
      });
    }
  });

  return router;
}

/**
 * Create webhook router (no JWT, uses signature verification)
 */
export function createWebhookRouter(
  stripeService: StripeService | MockStripeService,
  fondyService: FondyService | MockFondyService
): Router {
  const router = Router();

  /**
   * @route   POST /webhooks/stripe
   * @desc    Stripe webhook endpoint
   * @access  Public (signature verified)
   *
   * Note: This endpoint requires raw body for signature verification.
   * Must be mounted BEFORE json() middleware in http-server.ts
   */
  router.post(
    '/stripe',
    async (req: Request, res: Response) => {
      try {
        const signature = req.headers['stripe-signature'] as string;

        if (!signature) {
          logger.warn('Stripe webhook missing signature');
          return res.status(400).json({ error: 'Missing signature' });
        }

        // req.body should be raw buffer here
        const result = await stripeService.handleWebhook(
          req.body,
          signature
        );

        return res.json(result);
      } catch (error: any) {
        logger.error('Stripe webhook failed', {
          error: error.message,
        });
        return res.status(400).json({
          error: 'Webhook processing failed',
          message: error.message,
        });
      }
    }
  );

  /**
   * @route   POST /webhooks/fondy
   * @desc    Fondy callback endpoint
   * @access  Public (signature verified)
   */
  router.post('/fondy', async (req: Request, res: Response) => {
    try {
      await fondyService.handleCallback(req.body);
      res.json({ received: true });
    } catch (error: any) {
      logger.error('Fondy callback failed', {
        error: error.message,
      });
      res.status(400).json({
        error: 'Callback processing failed',
        message: error.message,
      });
    }
  });

  return router;
}
