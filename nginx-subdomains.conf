# Nginx Reverse Proxy Configuration for legal.org.ua
# Using subdomains instead of path-based routing

# Production backend
upstream prod_backend {
    server host.docker.internal:3001;
    keepalive 64;
}

# Development backend
upstream dev_backend {
    server host.docker.internal:3003;
    keepalive 64;
}

# Stage backend (using dev backend until stage is deployed)
upstream stage_backend {
    server host.docker.internal:3003;
    keepalive 64;
}

# Production frontend
upstream prod_frontend {
    server host.docker.internal:8090;
    keepalive 32;
}

# Development frontend
upstream dev_frontend {
    server host.docker.internal:8091;
    keepalive 32;
}

# Stage frontend (using dev frontend until stage is deployed)
upstream stage_frontend {
    server host.docker.internal:8091;
    keepalive 32;
}

# ========================================
# Production Environment: legal.org.ua
# ========================================
server {
    listen 80;
    server_name legal.org.ua;

    # Maximum upload size
    client_max_body_size 50M;

    # Logging
    access_log /var/log/nginx/legal.org.ua-access.log;
    error_log /var/log/nginx/legal.org.ua-error.log;

    # Backend health check
    location /health {
        proxy_pass http://prod_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        access_log off;
    }

    # Auth routes
    location /auth {
        proxy_pass http://prod_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # API routes
    location /api {
        proxy_pass http://prod_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # For SSE (Server-Sent Events) support
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;

        # CORS headers
        add_header Access-Control-Allow-Origin "$http_origin" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;
        add_header Access-Control-Allow-Credentials "true" always;

        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "$http_origin" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    # Frontend static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://prod_frontend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Frontend routes (SPA) - default
    location / {
        proxy_pass http://prod_frontend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }
}

# ========================================
# Development Environment: dev.legal.org.ua
# ========================================
server {
    listen 80;
    server_name dev.legal.org.ua;

    # Maximum upload size
    client_max_body_size 50M;

    # Logging
    access_log /var/log/nginx/dev.legal.org.ua-access.log;
    error_log /var/log/nginx/dev.legal.org.ua-error.log;

    # Backend health check
    location /health {
        proxy_pass http://dev_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        access_log off;
    }

    # Auth routes
    location /auth {
        proxy_pass http://dev_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # API routes
    location /api {
        proxy_pass http://dev_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # For SSE (Server-Sent Events) support
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;

        # CORS headers
        add_header Access-Control-Allow-Origin "$http_origin" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;
        add_header Access-Control-Allow-Credentials "true" always;

        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "$http_origin" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    # Frontend static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://dev_frontend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        expires 1h;
        add_header Cache-Control "public";
    }

    # Frontend routes (SPA)
    location / {
        proxy_pass http://dev_frontend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }
}

# ========================================
# Stage Environment: stage.legal.org.ua
# ========================================
server {
    listen 80;
    server_name stage.legal.org.ua;

    # Maximum upload size
    client_max_body_size 50M;

    # Logging
    access_log /var/log/nginx/stage.legal.org.ua-access.log;
    error_log /var/log/nginx/stage.legal.org.ua-error.log;

    # Backend health check
    location /health {
        proxy_pass http://stage_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        access_log off;
    }

    # Auth routes
    location /auth {
        proxy_pass http://stage_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # API routes
    location /api {
        proxy_pass http://stage_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # For SSE (Server-Sent Events) support
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;

        # CORS headers
        add_header Access-Control-Allow-Origin "$http_origin" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;
        add_header Access-Control-Allow-Credentials "true" always;

        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "$http_origin" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    # Frontend static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://stage_frontend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        expires 1h;
        add_header Cache-Control "public";
    }

    # Frontend routes (SPA)
    location / {
        proxy_pass http://stage_frontend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }
}
