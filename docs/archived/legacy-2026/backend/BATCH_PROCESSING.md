# üì¶ –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç **1800+ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ PostgreSQL –±–∞–∑–µ, **–ë–ï–ó –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏**.

## üéØ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç

1. **–ù–∞—Ö–æ–¥–∏—Ç** –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å `full_text`, –Ω–æ –±–µ–∑ —Å–µ–∫—Ü–∏–π
2. **–ò–∑–≤–ª–µ–∫–∞–µ—Ç** —Å–µ–∫—Ü–∏–∏ (FACTS, COURT_REASONING, LAW_REFERENCES, etc.)
3. **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç** —Å–µ–∫—Ü–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü—É `document_sections`
4. **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç** –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## üöÄ –ó–∞–ø—É—Å–∫

### –í–∞—Ä–∏–∞–Ω—Ç 1: Production (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤)
```bash
cd mcp_backend
npm run process:docs
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Development (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
```bash
cd mcp_backend
npm run process:docs:dev
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–í —Ñ–∞–π–ª–µ `scripts/process-existing-documents.ts`:

```typescript
const BATCH_SIZE = 10;        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –±–∞—Ç—á–µ
const USE_LLM = true;          // true = GPT-4o, false = —Ç–æ–ª—å–∫–æ regex
```

### –†–µ–∂–∏–º—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:

| –†–µ–∂–∏–º | –û–ø–∏—Å–∞–Ω–∏–µ | –°–∫–æ—Ä–æ—Å—Ç—å | –¢–æ—á–Ω–æ—Å—Ç—å | –°—Ç–æ–∏–º–æ—Å—Ç—å |
|-------|----------|----------|----------|-----------|
| **LLM (GPT-4o)** | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AI –¥–ª—è —Ç–æ—á–Ω–æ–π —ç–∫—Å—Ç—Ä–∞–∫—Ü–∏–∏ | –ú–µ–¥–ª–µ–Ω–Ω–æ (~5 doc/sec) | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ~$1.50/1000 docs |
| **Regex only** | –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º | –ë—ã—Å—Ç—Ä–æ (~50 doc/sec) | ‚≠ê‚≠ê‚≠ê | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–ª—è 1800 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `USE_LLM = false` –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, ~40 –º–∏–Ω—É—Ç), –∑–∞—Ç–µ–º –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞–∂–Ω—ã–µ –¥–µ–ª–∞ —Å `USE_LLM = true`.

## üìä –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
üöÄ Starting batch processing of existing documents...

üìä Statistics:
   Total documents in DB: 1882
   Already processed: 11
   To process: 1871

üîÑ Processing 1871 documents...

üì¶ Batch 1/188 (10 documents)
   ‚úÖ 110679112: 32 sections
   ‚úÖ 102008078: 64 sections
   ‚úÖ 63447364: 30 sections
   ...
   üìà Progress: 1% | 10/1871 | 320 sections | ETA: 2340s

üì¶ Batch 2/188 (10 documents)
   ...

‚úÖ Processing complete!

üìä Final Statistics:
   Processed: 1871
   Failed: 0
   Sections created: 45680
   Total time: 2400s
   Rate: 0.78 docs/sec
```

## üí∞ –û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

### –° GPT-4o (`USE_LLM = true`):
- **OpenAI API:** ~$2.50-$3.00 –¥–ª—è 1871 –¥–æ–∫—É–º–µ–Ω—Ç–∞
  - Model: `gpt-4o` (~$0.0015 –∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç)
  - –í–∫–ª—é—á–∞–µ—Ç: —Ç–æ—á–Ω—É—é —ç–∫—Å—Ç—Ä–∞–∫—Ü–∏—é —Å–µ–∫—Ü–∏–π —Å AI

### –ë–µ–∑ LLM (`USE_LLM = false`):
- **–ë–µ—Å–ø–ª–∞—Ç–Ω–æ** - —Ç–æ–ª—å–∫–æ regex –ø–∞—Ä—Å–∏–Ω–≥
- **–ü–ª—é—Å—ã:** –±—ã—Å—Ç—Ä–æ –∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ
- **–ú–∏–Ω—É—Å—ã:** –º–µ–Ω–µ–µ —Ç–æ—á–Ω–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## üîß –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –°–∫—Ä–∏–ø—Ç –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π –ø–∞–º—è—Ç–∏
```bash
# –£–≤–µ–ª–∏—á—å—Ç–µ —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–µ—Ä–∂–∫—É
BATCH_SIZE = 5;  // –£–º–µ–Ω—å—à–∏—Ç–µ —Å 10 –¥–æ 5
```

### –°–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ
```bash
# –û—Ç–∫–ª—é—á–∏—Ç–µ LLM –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
USE_LLM = false;
```

### Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–ø–∞–ª
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose up -d
```

## üìà –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É –≤–∞—Å –±—É–¥–µ—Ç:

1. **~45,000+ —Å–µ–∫—Ü–∏–π** –≤ —Ç–∞–±–ª–∏—Ü–µ `document_sections`
2. **–ì–æ—Ç–æ–≤–∞—è –±–∞–∑–∞** –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
3. **–î–∞–Ω–Ω—ã–µ** –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. **–°–æ–∑–¥–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞)
2. **–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã** —Å –ø–æ–º–æ—â—å—é `LegalPatternStore`
3. **–ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏** —á–µ—Ä–µ–∑ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

## üê≥ –ó–∞–ø—É—Å–∫ –≤ Docker

```bash
# –ò–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ mcp_backend
docker-compose exec app npm run process:docs
```

## ‚è±Ô∏è –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏

| –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ | –†–µ–∂–∏–º | –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è |
|-----------|-------|----------------|
| 1871 | Regex only | ~35-40 –º–∏–Ω—É—Ç |
| 1871 | GPT-4o | ~6-8 —á–∞—Å–æ–≤ |
| 100 | Regex only | ~2 –º–∏–Ω—É—Ç—ã |
| 100 | GPT-4o | ~20 –º–∏–Ω—É—Ç |

**–°–æ–≤–µ—Ç:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å –Ω–µ–±–æ–ª—å—à–∏–º –ª–∏–º–∏—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤) –¥–ª—è —Ç–µ—Å—Ç–∞:

```typescript
// –í —Å–∫—Ä–∏–ø—Ç–µ –¥–æ–±–∞–≤—å—Ç–µ –ª–∏–º–∏—Ç:
const documentsToProcess = result.rows.slice(0, 100); // –ü–µ—Ä–≤—ã–µ 100
```

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- ‚úÖ –°–∫—Ä–∏–ø—Ç **–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π** - –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–Ω–æ–≥–æ —Ä–∞–∑
- ‚úÖ –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞
- ‚úÖ –ú–æ–∂–Ω–æ –ø—Ä–µ—Ä–≤–∞—Ç—å Ctrl+C –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∑–∂–µ

## üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker logs secondlayer-app`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î: `docker exec secondlayer-postgres psql -U secondlayer -d secondlayer_db -c "SELECT COUNT(*) FROM documents"`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env`
