# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –≤—ã–±–æ—Ä—É –º–æ–¥–µ–ª–µ–π –≤ SecondLayer

**–î–∞—Ç–∞:** 2026-01-18
**–°—Ç–∞—Ç—É—Å:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–µ–π

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏](#–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç-–≤—ã–±–æ—Ä-–º–æ–¥–µ–ª–∏)
2. [–î–≤–∞ —Ä–µ–∂–∏–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏](#–¥–≤–∞-—Ä–µ–∂–∏–º–∞-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
3. [–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–æ–¥–µ–ª–∏](#–≥–¥–µ-–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è-–º–æ–¥–µ–ª–∏)
4. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-—á–µ—Ä–µ–∑-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-–æ–∫—Ä—É–∂–µ–Ω–∏—è)
5. [–ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π](#–ø—Ä–∏–º–µ—Ä—ã-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π)
6. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

---

## üéØ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏

### –°–∏—Å—Ç–µ–º–∞ –∏–º–µ–µ—Ç 3 —É—Ä–æ–≤–Ω—è "–±—é–¥–∂–µ—Ç–∞ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π":

| –ë—é–¥–∂–µ—Ç | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –ó–∞–¥–∞—á–∏ | –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –º–æ–¥–µ–ª—å |
|--------|-------------------|---------|---------------------|
| **quick** | –ö–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã (< 20 —Å–∏–º–≤–æ–ª–æ–≤) | –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤, –ø—Ä–æ—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã | gpt-4o-mini –∏–ª–∏ claude-haiku-4.5 |
| **standard** | –°—Ä–µ–¥–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã (20-200 —Å–∏–º–≤–æ–ª–æ–≤) | –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞, –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏–π | gpt-4o-mini –∏–ª–∏ claude-sonnet-4.5 |
| **deep** | –î–ª–∏–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (> 200 —Å–∏–º–≤–æ–ª–æ–≤), –±–æ–ª—å—à–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç | –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑, –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | gpt-4o –∏–ª–∏ claude-opus-4.5 |

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞:

**–§–∞–π–ª:** `mcp_backend/src/utils/model-selector.ts:103-131`

```typescript
static recommendBudget(params: {
  queryLength: number;
  requiresStructuredOutput?: boolean;
  contextSize?: number;
  userSpecified?: 'quick' | 'standard' | 'deep';
}): 'quick' | 'standard' | 'deep' {
  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
  if (params.userSpecified) {
    return params.userSpecified;
  }

  // –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã
  if (params.queryLength < 20) {
    return 'quick';
  }

  // –î–ª–∏–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏–ª–∏ –±–æ–ª—å—à–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
  if (params.queryLength > 200 || (params.contextSize && params.contextSize > 5000)) {
    return 'deep';
  }

  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - standard
  return 'standard';
}
```

---

## ‚öôÔ∏è –î–≤–∞ —Ä–µ–∂–∏–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –†–µ–∂–∏–º 1: SINGLE MODEL (–û–¥–Ω–∞ –º–æ–¥–µ–ª—å –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:** –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `OPENAI_MODEL`

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```typescript
// model-selector.ts —Å—Ç—Ä–æ–∫–∞ 29-32
if (this.SINGLE_MODEL) {
  logger.debug('Using single model for all budgets', { model: this.SINGLE_MODEL, budget });
  return this.SINGLE_MODEL;
}
```

**–ü—Ä–∏–º–µ—Ä .env:**
```bash
OPENAI_MODEL=gpt-4o  # ‚Üê –û–¥–Ω–∞ –º–æ–¥–µ–ª—å –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- quick ‚Üí gpt-4o
- standard ‚Üí gpt-4o
- deep ‚Üí gpt-4o

‚úÖ **–ü–ª—é—Å—ã:**
- –ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- –õ–µ–≥–∫–æ –¥–µ–±–∞–∂–∏—Ç—å

‚ùå **–ú–∏–Ω—É—Å—ã:**
- –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–æ—Ä–æ–≥–∞—è –º–æ–¥–µ–ª—å –¥–∞–∂–µ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á)
- –ù–µ—Ç –≥–∏–±–∫–æ—Å—Ç–∏

---

### –†–µ–∂–∏–º 2: DYNAMIC MODEL SELECTION (–†–∞–∑–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:** –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ `OPENAI_MODEL`, –Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```typescript
// model-selector.ts —Å—Ç—Ä–æ–∫–∞ 36-45
const models = {
  quick: this.QUICK_MODEL,      // –∏–∑ OPENAI_MODEL_QUICK
  standard: this.STANDARD_MODEL, // –∏–∑ OPENAI_MODEL_STANDARD
  deep: this.DEEP_MODEL,         // –∏–∑ OPENAI_MODEL_DEEP
};

const selectedModel = models[budget];
logger.debug('Selected chat model', { budget, model: selectedModel });

return selectedModel;
```

**–ü—Ä–∏–º–µ—Ä .env:**
```bash
# –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ OPENAI_MODEL
OPENAI_MODEL_QUICK=gpt-4o-mini       # –î–µ—à–µ–≤–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á
OPENAI_MODEL_STANDARD=gpt-4o-mini    # –°—Ä–µ–¥–Ω—è—è –º–æ–¥–µ–ª—å
OPENAI_MODEL_DEEP=gpt-4o             # –ú–æ—â–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- quick ‚Üí gpt-4o-mini ($0.15 input / $0.60 output)
- standard ‚Üí gpt-4o-mini ($0.15 input / $0.60 output)
- deep ‚Üí gpt-4o ($2.50 input / $10.00 output)

‚úÖ **–ü–ª—é—Å—ã:**
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–¥–µ—à–µ–≤—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á)
- –ì–∏–±–∫–æ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª–∏ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (OpenAI + Claude)

‚ùå **–ú–∏–Ω—É—Å—ã:**
- –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- –ù—É–∂–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏

---

## üìç –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–æ–¥–µ–ª–∏

### 1. Query Planner (–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏–π)

**–§–∞–π–ª:** `mcp_backend/src/services/query-planner.ts:20-31`

```typescript
async classifyIntent(query: string, budget: 'quick' | 'standard' | 'deep' = 'standard'): Promise<QueryIntent> {
  // –î–ª—è quick –±—é–¥–∂–µ—Ç–∞ - –ø—Ä–æ—Å—Ç–æ–π keyword matching (–ë–ï–ó –º–æ–¥–µ–ª–∏)
  if (budget === 'quick') {
    return this.quickIntentClassification(query);
  }

  // –î–ª—è standard/deep - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LLM
  const model = ModelSelector.getChatModel(budget);  // ‚Üê –í–´–ë–û–† –ú–û–î–ï–õ–ò

  const response = await this.openaiManager.executeWithRetry(async (client) => {
    return await client.chat.completions.create({
      model: model,  // ‚Üê –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –í–´–ë–†–ê–ù–ù–ê–Ø –ú–û–î–ï–õ–¨
      messages: [...],
      temperature: 0.3,
      max_tokens: 500,
    });
  });
}
```

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
- `budget='quick'` ‚Üí regex keyword matching (–ë–ï–ó API –≤—ã–∑–æ–≤–∞)
- `budget='standard'` ‚Üí gpt-4o-mini (–¥–µ—à–µ–≤–æ)
- `budget='deep'` ‚Üí gpt-4o (–¥–æ—Ä–æ–≥–æ, –Ω–æ —Ç–æ—á–Ω–µ–µ)

---

### 2. Embedding Service (–í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞)

**–§–∞–π–ª:** `mcp_backend/src/services/embedding-service.ts:52-60`

```typescript
async generateEmbedding(text: string): Promise<number[]> {
  const model = ModelSelector.getEmbeddingModel();  // ‚Üê –í–°–ï–ì–î–ê –û–î–ù–ê –ú–û–î–ï–õ–¨!

  const response = await this.openaiManager.executeWithRetry(async (client) => {
    return await client.embeddings.create({
      model,  // ‚Üê text-embedding-ada-002 –∏–ª–∏ –¥—Ä—É–≥–∞—è embedding –º–æ–¥–µ–ª—å
      input: text,
    });
  });

  return response.data[0].embedding;
}
```

**–í–∞–∂–Ω–æ:** Embedding –º–æ–¥–µ–ª—å –ù–ï –º–µ–Ω—è–µ—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ:
- –í–µ–∫—Ç–æ—Ä—ã —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã
- –ù–µ–ª—å–∑—è –∏—Å–∫–∞—Ç—å –≤ Qdrant, –µ—Å–ª–∏ –≤–µ–∫—Ç–æ—Ä—ã —Å–æ–∑–¥–∞–Ω—ã —Ä–∞–∑–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏
- –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π (ada-002 = 1536, text-embedding-3-large = 3072)

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```bash
OPENAI_EMBEDDING_MODEL=text-embedding-ada-002  # –ù–µ –º–µ–Ω—è–π—Ç–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤!
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**
- `text-embedding-ada-002`: $0.10/MTok (1536 dim) - –¢–ï–ö–£–©–ê–Ø
- `text-embedding-3-small`: $0.02/MTok (1536 dim) - **5x –î–ï–®–ï–í–õ–ï!**
- `text-embedding-3-large`: $0.13/MTok (3072 dim) - —Å–∞–º–∞—è —Ç–æ—á–Ω–∞—è

---

### 3. Semantic Sectionizer (–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)

**–§–∞–π–ª:** `mcp_backend/src/services/semantic-sectionizer.ts:212-232`

```typescript
private async llmAssistedExtraction(text: string): Promise<DocumentSection[]> {
  const response = await this.openaiManager.executeWithRetry(async (client) => {
    // –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ—Ç deep –º–æ–¥–µ–ª—å –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
    const model = ModelSelector.getChatModel('deep');  // ‚Üê –ñ–ï–°–¢–ö–û –ó–ê–ö–û–î–ò–†–û–í–ê–ù–û 'deep'

    return await client.chat.completions.create({
      model,  // ‚Üê gpt-4o –∏–ª–∏ claude-opus-4.5
      messages: [
        {
          role: 'system',
          content: `–¢–∏ –µ–∫—Å–ø–µ—Ä—Ç –∑ –∞–Ω–∞–ª—ñ–∑—É —é—Ä–∏–¥–∏—á–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤. –†–æ–∑–±–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å–µ–º–∞–Ω—Ç–∏—á–Ω—ñ —Å–µ–∫—Ü—ñ—ó...`,
        },
        { role: 'user', content: text },
      ],
      temperature: 0.2,
      max_tokens: 2000,
    });
  });
}
```

**–ü–æ—á–µ–º—É 'deep'?**
- –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å–ª–æ–∂–Ω—ã–µ
- –ù—É–∂–Ω–∞ –≤—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π
- –û—à–∏–±–∫–∏ –¥–æ—Ä–æ–≥–æ –æ–±—Ö–æ–¥—è—Ç—Å—è (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è = –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑)

---

### 4. HTML Parser (–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏–∑ HTML)

**–§–∞–π–ª:** `mcp_backend/src/utils/html-parser.ts`

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç `ModelSelector.getChatModel('quick')` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏–∑ HTML.

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env):

```bash
# ‚ùå –¢–ï–ö–£–©–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø - SINGLE MODEL
OPENAI_MODEL=gpt-4o

# ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø - DYNAMIC SELECTION
# –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ OPENAI_MODEL –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
OPENAI_MODEL_QUICK=gpt-4o-mini       # $0.15/$0.60
OPENAI_MODEL_STANDARD=gpt-4o-mini    # $0.15/$0.60
OPENAI_MODEL_DEEP=gpt-4o             # $2.50/$10.00

# Embedding –º–æ–¥–µ–ª—å (–ù–ï –ú–ï–ù–Ø–ô–¢–ï –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤!)
OPENAI_EMBEDDING_MODEL=text-embedding-ada-002  # $0.10/MTok
```

### Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:

**–§–∞–π–ª:** `mcp_backend/docker-compose.yml:67-76`

```yaml
environment:
  # OpenAI Configuration
  OPENAI_API_KEY: ${OPENAI_API_KEY}
  OPENAI_API_KEY2: ${OPENAI_API_KEY2:-}
  OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-ada-002}

  # Dynamic model selection (recommended) ‚úÖ
  OPENAI_MODEL_QUICK: ${OPENAI_MODEL_QUICK:-gpt-4o-mini}
  OPENAI_MODEL_STANDARD: ${OPENAI_MODEL_STANDARD:-gpt-4o-mini}
  OPENAI_MODEL_DEEP: ${OPENAI_MODEL_DEEP:-gpt-4o}

  # OR single model for all tasks ‚ùå
  # OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
```

**–ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ .env):**
- `OPENAI_MODEL_QUICK`: gpt-4o-mini
- `OPENAI_MODEL_STANDARD`: gpt-4o-mini
- `OPENAI_MODEL_DEEP`: gpt-4o
- `OPENAI_EMBEDDING_MODEL`: text-embedding-ada-002

---

## üí° –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è 1: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è üí∞

```bash
# .env
OPENAI_MODEL_QUICK=gpt-4o-mini
OPENAI_MODEL_STANDARD=gpt-4o-mini
OPENAI_MODEL_DEEP=gpt-4o-mini
OPENAI_EMBEDDING_MODEL=text-embedding-3-small  # 5x –¥–µ—à–µ–≤–ª–µ!
```

**–°—Ç–æ–∏–º–æ—Å—Ç—å:**
- Chat: $0.15 input / $0.60 output
- Embeddings: $0.02 / MTok

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ü—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- –ù–µ–±–æ–ª—å—à–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
- –ù–µ–∫—Ä–∏—Ç–∏—á–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å

---

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è 2: –ë–∞–ª–∞–Ω—Å —Ü–µ–Ω–∞/–∫–∞—á–µ—Å—Ç–≤–æ ‚úÖ (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

```bash
# .env
OPENAI_MODEL_QUICK=gpt-4o-mini
OPENAI_MODEL_STANDARD=gpt-4o-mini
OPENAI_MODEL_DEEP=gpt-4o
OPENAI_EMBEDDING_MODEL=text-embedding-ada-002
```

**–°—Ç–æ–∏–º–æ—Å—Ç—å:**
- Quick/Standard: $0.15 / $0.60 (–¥–µ—à–µ–≤–æ)
- Deep: $2.50 / $10.00 (—Ç–æ—á–Ω–æ)
- Embeddings: $0.10 / MTok

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- Production –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- –°—Ä–µ–¥–Ω—è—è –∏ –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
- –ù—É–∂–µ–Ω –±–∞–ª–∞–Ω—Å —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞

---

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è 3: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ üéØ

```bash
# .env
OPENAI_MODEL_QUICK=gpt-4o
OPENAI_MODEL_STANDARD=gpt-4o
OPENAI_MODEL_DEEP=gpt-4o
OPENAI_EMBEDDING_MODEL=text-embedding-3-large
```

**–°—Ç–æ–∏–º–æ—Å—Ç—å:**
- Chat: $2.50 input / $10.00 output
- Embeddings: $0.13 / MTok

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∞–Ω–∞–ª–∏–∑—ã
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
- –ú–∞–ª—ã–π –æ–±—ä–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤

---

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è 4: –ì–∏–±—Ä–∏–¥–Ω–∞—è (OpenAI + Claude) üîÄ

```bash
# .env - –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –†–ê–ó–ù–´–ï –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
OPENAI_MODEL_QUICK=gpt-4o-mini           # OpenAI –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–¥–∞—á
OPENAI_MODEL_STANDARD=claude-haiku-4.5   # Claude –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö –∑–∞–¥–∞—á
OPENAI_MODEL_DEEP=claude-opus-4.5        # Claude –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á
OPENAI_EMBEDDING_MODEL=text-embedding-ada-002
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Claude –Ω—É–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Anthropic SDK!

**–°—Ç–æ–∏–º–æ—Å—Ç—å:**
- Quick: $0.15 / $0.60 (OpenAI)
- Standard: $1.00 / $5.00 (Claude Haiku)
- Deep: $5.00 / $25.00 (Claude Opus)

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

```bash
OPENAI_MODEL_QUICK=gpt-4o-mini
OPENAI_MODEL_STANDARD=gpt-4o-mini
OPENAI_MODEL_DEEP=gpt-4o-mini
```

**–≠–∫–æ–Ω–æ–º–∏—è:** ~90% –Ω–∞ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

---

### 2. –î–ª—è production (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):

```bash
# –£–¥–∞–ª–∏—Ç–µ –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ OPENAI_MODEL
# OPENAI_MODEL=gpt-4o  ‚Üê –£–î–ê–õ–ò–¢–¨!

# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ dynamic selection
OPENAI_MODEL_QUICK=gpt-4o-mini
OPENAI_MODEL_STANDARD=gpt-4o-mini
OPENAI_MODEL_DEEP=gpt-4o
```

**–≠–∫–æ–Ω–æ–º–∏—è:** ~70% –Ω–∞ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –∑–∞–ø—Ä–æ—Å–æ–≤

---

### 3. –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –±–æ–ª–µ–µ –¥–µ—à–µ–≤—ã–µ embeddings:

**‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï:** –ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤ Qdrant –Ω–µ—Ç –≤–µ–∫—Ç–æ—Ä–æ–≤ –∏–ª–∏ –≤—ã –≥–æ—Ç–æ–≤—ã –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –í–°–Å!

```bash
# –®–∞–≥ 1: –û—á–∏—Å—Ç–∏—Ç–µ Qdrant (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
docker exec secondlayer-qdrant curl -X DELETE http://localhost:6333/collections/legal_sections

# –®–∞–≥ 2: –ò–∑–º–µ–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å
OPENAI_EMBEDDING_MODEL=text-embedding-3-small  # 5x –¥–µ—à–µ–≤–ª–µ!

# –®–∞–≥ 3: –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–π—Ç–µ –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
npm run reindex-all
```

**–≠–∫–æ–Ω–æ–º–∏—è:** $0.10 ‚Üí $0.02 (80% —ç–∫–æ–Ω–æ–º–∏–∏ –Ω–∞ embeddings)

---

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SQL –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```sql
SELECT
  call->>'model' AS model,
  call->>'task' AS task,
  COUNT(*) AS calls,
  SUM((call->>'cost_usd')::numeric) AS total_cost
FROM cost_tracking,
     jsonb_array_elements(openai_calls) AS call
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY model, task
ORDER BY total_cost DESC;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
model          | task                   | calls | total_cost
---------------|------------------------|-------|------------
gpt-4o         | deep_analysis          | 145   | $2.45
gpt-4o-mini    | intent_classification  | 432   | $0.10
gpt-4o         | section_extraction     | 89    | $0.78
```

**–î–µ–π—Å—Ç–≤–∏–µ:** –ï—Å–ª–∏ `deep_analysis` —Å–ª–∏—à–∫–æ–º –¥–æ—Ä–æ–≥–æ ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –Ω–∞ `gpt-4o-mini` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

---

## üìä –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | 1000 quick –∑–∞–ø—Ä–æ—Å–æ–≤ | 1000 standard –∑–∞–ø—Ä–æ—Å–æ–≤ | 100 deep –∑–∞–ø—Ä–æ—Å–æ–≤ | –ò–¢–û–ì–û |
|--------------|---------------------|------------------------|-------------------|-------|
| **All gpt-4o** | ~$6.00 | ~$6.00 | ~$6.00 | **~$18.00** |
| **Dynamic (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)** | ~$0.18 | ~$0.18 | ~$6.00 | **~$6.36** |
| **All gpt-4o-mini** | ~$0.18 | ~$0.18 | ~$0.18 | **~$0.54** |

**–≠–∫–æ–Ω–æ–º–∏—è —Å dynamic –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π:** 65% vs all gpt-4o

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –£–∑–Ω–∞—Ç—å –∫–∞–∫–∞—è –º–æ–¥–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

```bash
# –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker exec secondlayer-app env | grep OPENAI_MODEL

# –†–µ–∑—É–ª—å—Ç–∞—Ç –µ—Å–ª–∏ SINGLE MODEL:
OPENAI_MODEL=gpt-4o

# –†–µ–∑—É–ª—å—Ç–∞—Ç –µ—Å–ª–∏ DYNAMIC SELECTION:
OPENAI_MODEL_QUICK=gpt-4o-mini
OPENAI_MODEL_STANDARD=gpt-4o-mini
OPENAI_MODEL_DEEP=gpt-4o
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```bash
docker logs secondlayer-app | grep "Selected chat model"
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
Selected chat model { budget: 'quick', model: 'gpt-4o-mini' }
Selected chat model { budget: 'standard', model: 'gpt-4o-mini' }
Selected chat model { budget: 'deep', model: 'gpt-4o' }
```

---

## üìù –†–µ–∑—é–º–µ

### ‚úÖ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

1. **–°–∏—Å—Ç–µ–º–∞ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ**
2. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 2 —Ä–µ–∂–∏–º–∞:** Single Model –∏ Dynamic Selection
3. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
4. **–°—á–∏—Ç–∞–µ—Ç —Ç–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å** –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏

### ‚öôÔ∏è –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env):

```bash
OPENAI_MODEL=gpt-4o  # ‚Üê SINGLE MODEL —Ä–µ–∂–∏–º
```

**–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:** –í–°–ï –∑–∞–¥–∞—á–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç gpt-4o ($2.50/$10.00)

### üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:

**–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ Dynamic Selection –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏:**

```bash
# –£–¥–∞–ª–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É –∏–∑ .env:
# OPENAI_MODEL=gpt-4o

# –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏:
OPENAI_MODEL_QUICK=gpt-4o-mini
OPENAI_MODEL_STANDARD=gpt-4o-mini
OPENAI_MODEL_DEEP=gpt-4o
```

**–≠–∫–æ–Ω–æ–º–∏—è:** ~65% –Ω–∞ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –∑–∞–ø—Ä–æ—Å–æ–≤

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-01-18
**–ê–≤—Ç–æ—Ä:** SecondLayer Team
