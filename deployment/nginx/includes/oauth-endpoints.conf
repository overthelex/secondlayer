# OAuth 2.0 Endpoints Configuration
# Included in stage.legal.org.ua.conf

# ==========================================
# OAuth Discovery Endpoints (RFC 8414)
# ==========================================

# OAuth Authorization Server Metadata
# Rewrite to /oauth/.well-known/... for backend compatibility
location = /.well-known/oauth-authorization-server {
    rewrite ^/.well-known/oauth-authorization-server$ /oauth/.well-known/oauth-authorization-server break;
    proxy_pass http://stage_mcp_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";

    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;
}

# OpenID Connect Discovery
location = /.well-known/openid-configuration {
    rewrite ^/.well-known/openid-configuration$ /oauth/.well-known/openid-configuration break;
    proxy_pass http://stage_mcp_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";

    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;
}

# ==========================================
# OAuth Authorization Flow
# ==========================================

# OAuth routes (authorize, token, revoke)
location /oauth/ {
    proxy_pass http://stage_mcp_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";

    add_header Access-Control-Allow-Origin "$http_origin" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;
    add_header Access-Control-Allow-Credentials "true" always;

    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "$http_origin" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
}

# ==========================================
# Compatibility Redirects
# ==========================================

# Redirect /authorize to /oauth/authorize (for Claude.ai)
location = /authorize {
    return 301 https://$host/oauth/authorize$is_args$args;
}

# Redirect /token to /oauth/token
location = /token {
    return 307 https://$host/oauth/token;
}
