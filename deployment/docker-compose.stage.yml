services:
  postgres-stage:
    image: postgres:15-alpine
    container_name: secondlayer-postgres-stage
    command: >-
      postgres
      -c max_connections=500
      -c shared_buffers=8GB
      -c effective_cache_size=40GB
      -c work_mem=128MB
      -c maintenance_work_mem=2GB
      -c wal_buffers=64MB
      -c idle_in_transaction_session_timeout=60000
      -c statement_timeout=300000
      -c lock_timeout=30000
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-secondlayer}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      TZ: Europe/Kiev
    ports:
    - "127.0.0.1:5434:5432"
    volumes:
    - postgres_stage_data:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER:-secondlayer} -d ${POSTGRES_DB:-secondlayer_stage}
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
    - secondlayer-stage-network
    deploy:
      resources:
        limits:
          memory: 12G
        reservations:
          memory: 8G

  # PgBouncer connection pooler for PostgreSQL
  pgbouncer-stage:
    image: edoburu/pgbouncer:latest
    container_name: secondlayer-pgbouncer-stage
    ports:
    - "127.0.0.1:5437:5432"
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-secondlayer}:${POSTGRES_PASSWORD}@postgres-stage:5432/${POSTGRES_DB:-secondlayer_stage}
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 500
      DEFAULT_POOL_SIZE: 50
      MIN_POOL_SIZE: 10
      RESERVE_POOL_SIZE: 10
      RESERVE_POOL_TIMEOUT: 5
      SERVER_ROUND_ROBIN: 1
      TZ: Europe/Kiev
    depends_on:
      postgres-stage:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -p 5432"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
    - secondlayer-stage-network
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # RADA MCP Database Initialization - creates schema and user in main DB
  rada-db-init-stage:
    image: postgres:15-alpine
    container_name: rada-db-init-stage
    depends_on:
      postgres-stage:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: "5432"
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_USER: ${POSTGRES_USER:-secondlayer}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      RADA_POSTGRES_USER: ${RADA_POSTGRES_USER:-rada_mcp}
      RADA_POSTGRES_PASSWORD: ${RADA_POSTGRES_PASSWORD}
      RADA_POSTGRES_SCHEMA: ${RADA_POSTGRES_SCHEMA:-rada}
      TZ: Europe/Kiev
    volumes:
      - ./scripts/rada-db-init.sh:/scripts/rada-db-init.sh:ro
    command: ["sh", "/scripts/rada-db-init.sh"]
    restart: "no"
    networks:
      - secondlayer-stage-network

  # OpenReyestr PostgreSQL Database (pre-loaded with EDR data from data.gov.ua)
  postgres-openreyestr-stage:
    image: mcvovkes/openreyestr-db:latest
    container_name: openreyestr-postgres-stage
    command: >-
      postgres
      -c max_connections=200
      -c shared_buffers=2GB
      -c effective_cache_size=6GB
      -c work_mem=128MB
      -c maintenance_work_mem=1GB
      -c idle_in_transaction_session_timeout=60000
      -c statement_timeout=300000
      -c lock_timeout=30000
    environment:
      POSTGRES_USER: ${OPENREYESTR_POSTGRES_USER:-openreyestr}
      POSTGRES_PASSWORD: ${OPENREYESTR_POSTGRES_PASSWORD}
      POSTGRES_DB: ${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}
      TZ: Europe/Kiev
    ports:
      - "127.0.0.1:5436:5432"
    volumes:
      - postgres_openreyestr_stage_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${OPENREYESTR_POSTGRES_USER:-openreyestr} -d ${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    networks:
      - secondlayer-stage-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 2G

  qdrant-stage:
    image: qdrant/qdrant:latest
    container_name: secondlayer-qdrant-stage
    ports:
    - "127.0.0.1:6337:6333"
    - "127.0.0.1:6338:6334"
    volumes:
    - qdrant_stage_data:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/6333'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    networks:
    - secondlayer-stage-network
    environment:
      TZ: Europe/Kiev
      QDRANT__STORAGE__OPTIMIZERS__MEMMAP_THRESHOLD_KB: "1048576"
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G
  redis-stage:
    image: redis:7-alpine
    container_name: secondlayer-redis-stage
    ports:
    - "127.0.0.1:6381:6379"
    volumes:
    - redis_stage_data:/data
    command: redis-server --appendonly yes --maxmemory 8192mb --maxmemory-policy volatile-lru
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    networks:
    - secondlayer-stage-network
    environment:
      TZ: Europe/Kiev
    deploy:
      resources:
        limits:
          memory: 9G
        reservations:
          memory: 4G
  migrate-stage:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.mono-backend
    image: secondlayer-app:latest
    container_name: secondlayer-migrate-stage
    depends_on:
      postgres-stage:
        condition: service_healthy
      redis-stage:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-secondlayer}:${POSTGRES_PASSWORD}@postgres-stage:5432/${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-secondlayer}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NODE_ENV: staging
      TZ: Europe/Kiev
    working_dir: /app/mcp_backend
    command:
    - node
    - dist/migrations/migrate.js
    restart: 'no'
    networks:
    - secondlayer-stage-network

  # Admin User Seed (runs after backend migration)
  seed-admin-stage:
    image: secondlayer-app:latest
    container_name: secondlayer-seed-admin-stage
    depends_on:
      migrate-stage:
        condition: service_completed_successfully
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-secondlayer}:${POSTGRES_PASSWORD}@postgres-stage:5432/${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-secondlayer}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      ADMIN_USERS: ${ADMIN_USERS}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NODE_ENV: staging
      TZ: Europe/Kiev
    working_dir: /app/mcp_backend
    command: ["node", "dist/scripts/seed-admin-user.js"]
    restart: "no"
    networks:
      - secondlayer-stage-network

  # RADA MCP Migrations
  rada-migrate-stage:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.mono-rada
    image: rada-mcp:latest
    container_name: rada-mcp-migrate-stage
    depends_on:
      rada-db-init-stage:
        condition: service_completed_successfully
      redis-stage:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${RADA_POSTGRES_USER:-rada_mcp}
      POSTGRES_PASSWORD: ${RADA_POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_SCHEMA: ${RADA_POSTGRES_SCHEMA:-rada}
      REDIS_URL: redis://redis-stage:6379
      REDIS_HOST: redis-stage
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NODE_ENV: staging
      TZ: Europe/Kiev
    command: ["node", "dist/migrations/migrate.js"]
    restart: "no"
    networks:
      - secondlayer-stage-network

  # RADA MCP Application Server
  rada-mcp-app-stage:
    image: rada-mcp:latest
    container_name: rada-mcp-app-stage
    command: ["node", "--max-old-space-size=3072", "dist/http-server.js"]
    depends_on:
      rada-migrate-stage:
        condition: service_completed_successfully
      redis-stage:
        condition: service_healthy
    environment:
      NODE_ENV: staging
      PORT: 3001
      HTTP_PORT: 3001
      HTTP_HOST: 0.0.0.0
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${RADA_POSTGRES_USER:-rada_mcp}
      POSTGRES_PASSWORD: ${RADA_POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_SCHEMA: ${RADA_POSTGRES_SCHEMA:-rada}
      REDIS_URL: redis://redis-stage:6379
      REDIS_HOST: redis-stage
      REDIS_PORT: 6379
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL_QUICK: ${OPENAI_MODEL_QUICK:-gpt-5-nano}
      OPENAI_MODEL_STANDARD: ${OPENAI_MODEL_STANDARD:-gpt-5-mini}
      OPENAI_MODEL_DEEP: ${OPENAI_MODEL_DEEP:-gpt-5.1}
      LLM_PROVIDER_STRATEGY: ${LLM_PROVIDER_STRATEGY:-openai-first}
      SECONDLAYER_URL: http://app-stage:3000
      SECONDLAYER_API_KEY: ${SECONDARY_LAYER_KEYS}
      RADA_API_KEYS: ${RADA_API_KEYS}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-https://stage.legal.org.ua}
      TZ: Europe/Kiev
    # Ports removed - service accessed via unified gateway only
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - secondlayer-stage-network
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # OpenReyestr MCP Migrations
  migrate-openreyestr-stage:
    image: openreyestr-app:latest
    build:
      context: ..
      dockerfile: deployment/Dockerfile.mono-openreyestr
    container_name: openreyestr-migrate-stage
    depends_on:
      postgres-openreyestr-stage:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${OPENREYESTR_POSTGRES_USER:-openreyestr}:${OPENREYESTR_POSTGRES_PASSWORD}@postgres-openreyestr-stage:5432/${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}
      POSTGRES_HOST: postgres-openreyestr-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${OPENREYESTR_POSTGRES_USER:-openreyestr}
      POSTGRES_PASSWORD: ${OPENREYESTR_POSTGRES_PASSWORD}
      POSTGRES_DB: ${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NODE_ENV: staging
      TZ: Europe/Kiev
    command: ["node", "dist/migrations/migrate.js"]
    restart: "no"
    networks:
      - secondlayer-stage-network

  # OpenReyestr MCP Application Server
  app-openreyestr-stage:
    image: openreyestr-app:latest
    container_name: openreyestr-app-stage
    command: ["node", "dist/http-server.js"]
    environment:
      NODE_ENV: staging
      HTTP_PORT: 3005
      HTTP_HOST: 0.0.0.0
      DATABASE_URL: postgresql://${OPENREYESTR_POSTGRES_USER:-openreyestr}:${OPENREYESTR_POSTGRES_PASSWORD}@postgres-openreyestr-stage:5432/${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}
      POSTGRES_HOST: postgres-openreyestr-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${OPENREYESTR_POSTGRES_USER:-openreyestr}
      POSTGRES_PASSWORD: ${OPENREYESTR_POSTGRES_PASSWORD}
      POSTGRES_DB: ${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}
      OPENREYESTR_API_KEYS: ${OPENREYESTR_API_KEYS}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL_QUICK: ${OPENAI_MODEL_QUICK:-gpt-5-nano}
      OPENAI_MODEL_STANDARD: ${OPENAI_MODEL_STANDARD:-gpt-5-mini}
      OPENAI_MODEL_DEEP: ${OPENAI_MODEL_DEEP:-gpt-5.1}
      SECONDLAYER_URL: http://app-stage:3000
      SECONDLAYER_API_KEY: ${SECONDARY_LAYER_KEYS}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NODE_OPTIONS: --max-old-space-size=6144
      TZ: Europe/Kiev
    # Ports removed - service accessed via unified gateway only
    depends_on:
      postgres-openreyestr-stage:
        condition: service_healthy
      migrate-openreyestr-stage:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - secondlayer-stage-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M

  # MinIO - S3-compatible object storage for media/large files
  minio-stage:
    image: minio/minio:latest
    container_name: minio-stage
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_PROMETHEUS_AUTH_TYPE: public
      TZ: Europe/Kiev
    ports:
      - "127.0.0.1:9004:9000"   # S3 API
      - "127.0.0.1:9005:9001"   # Web console
    volumes:
      - minio_stage_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - secondlayer-stage-network

  app-stage:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.mono-backend
    image: secondlayer-app:latest
    container_name: secondlayer-app-stage
    command:
    - node
    - --max-old-space-size=8192
    - dist/http-server.js
    environment:
      NODE_ENV: staging
      HTTP_PORT: ${HTTP_PORT:-3000}
      HTTP_HOST: 0.0.0.0
      JWT_SECRET: ${JWT_SECRET}
      DATABASE_URL: postgresql://${POSTGRES_USER:-secondlayer}:${POSTGRES_PASSWORD}@postgres-stage:5432/${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-secondlayer}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      QDRANT_URL: http://qdrant-stage:6333
      REDIS_URL: redis://redis-stage:6379
      REDIS_HOST: redis-stage
      REDIS_PORT: 6379
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_API_KEY2: ${OPENAI_API_KEY2:-}
      OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      OPENAI_MODEL_QUICK: ${OPENAI_MODEL_QUICK:-gpt-5-nano}
      OPENAI_MODEL_STANDARD: ${OPENAI_MODEL_STANDARD:-gpt-5-mini}
      OPENAI_MODEL_DEEP: ${OPENAI_MODEL_DEEP:-gpt-5.1}
      LLM_PROVIDER_STRATEGY: ${LLM_PROVIDER_STRATEGY:-openai-first}
      VOYAGEAI_API_KEY: ${VOYAGEAI_API_KEY}
      VOYAGEAI_EMBEDDING_MODEL: ${VOYAGEAI_EMBEDDING_MODEL:-voyage-multilingual-2}
      ZAKONONLINE_API_TOKEN: ${ZAKONONLINE_API_TOKEN}
      ZAKONONLINE_API_TOKEN2: ${ZAKONONLINE_API_TOKEN2:-}
      SECONDARY_LAYER_KEYS: ${SECONDARY_LAYER_KEYS}

      # Document Service (scraping delegation)
      DOCUMENT_SERVICE_URL: http://document-service-stage:3002

      # Unified Gateway Configuration
      ENABLE_UNIFIED_GATEWAY: "true"
      RADA_MCP_URL: http://rada-mcp-app-stage:3001
      RADA_API_KEY: ${RADA_API_KEY}
      OPENREYESTR_MCP_URL: http://app-openreyestr-stage:3005
      OPENREYESTR_API_KEY: ${OPENREYESTR_API_KEY}

      # Google Cloud Vision API (for OCR in document analysis tools)
      VISION_CREDENTIALS_PATH: /app/credentials/vision-credentials.json
      GOOGLE_APPLICATION_CREDENTIALS: /app/credentials/vision-credentials.json

      # WebAuthn / FIDO2
      WEBAUTHN_RP_ID: ${WEBAUTHN_RP_ID:-legal.org.ua}
      WEBAUTHN_RP_NAME: ${WEBAUTHN_RP_NAME:-SecondLayer Legal}
      WEBAUTHN_ORIGIN: ${WEBAUTHN_ORIGIN:-https://legal.org.ua,https://stage.legal.org.ua}

      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_CALLBACK_URL: https://legal.org.ua/auth/google/callback
      FRONTEND_URL: https://legal.org.ua
      ALLOWED_ORIGINS: https://legal.org.ua,https://stage.legal.org.ua,https://mcp.legal.org.ua,https://stage.mcp.legal.org.ua
      # MinIO (S3-compatible object storage)
      MINIO_ENDPOINT: minio-stage
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_USE_SSL: "false"

      # Upload temp directory
      UPLOAD_TEMP_DIR: /app/data/uploads

      # Email (postfix on mail server, IP-based auth via submission/STARTTLS)
      SMTP_HOST: mail.lexapp.co.ua
      SMTP_PORT: "587"
      SMTP_SECURE: "false"
      EMAIL_FROM: noreply@legal.org.ua
      EMAIL_FROM_NAME: SecondLayer Legal Platform

      # Prometheus (for admin metrics dashboard)
      PROMETHEUS_URL: http://prometheus-stage:9090

      LOG_LEVEL: ${LOG_LEVEL:-info}
      TZ: Europe/Kiev
    ports:
    - "127.0.0.1:3004:3000"
    depends_on:
      postgres-stage:
        condition: service_healthy
      qdrant-stage:
        condition: service_healthy
      redis-stage:
        condition: service_healthy
      migrate-stage:
        condition: service_completed_successfully
    volumes:
    - ../mcp_backend/logs:/app/logs
    - app_stage_data:/app/data
    # Vision API credentials for document analysis (OCR)
    - ../vision-ocr-credentials.json:/app/credentials/vision-credentials.json:ro
    healthcheck:
      test:
      - CMD
      - wget
      - --spider
      - -q
      - http://127.0.0.1:3000/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
    - secondlayer-stage-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 10G
        reservations:
          cpus: '0.5'
          memory: 4G
  # Document Analysis Service (OCR, PDF parsing)
  document-service-stage:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.document-service
    image: document-service:latest
    container_name: document-service-stage
    command: ["node", "--max-old-space-size=5120", "--expose-gc", "dist/document-service.js"]
    depends_on:
      postgres-stage:
        condition: service_healthy
      qdrant-stage:
        condition: service_started
      redis-stage:
        condition: service_healthy
    environment:
      # Application
      NODE_ENV: staging
      DOCUMENT_SERVICE_PORT: 3002
      PORT: 3002
      HTTP_PORT: 3002
      HTTP_HOST: 0.0.0.0

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-secondlayer}:${POSTGRES_PASSWORD}@postgres-stage:5432/${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-secondlayer}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}

      # Vector DB
      QDRANT_URL: http://qdrant-stage:6333

      # Cache
      REDIS_URL: redis://redis-stage:6379
      REDIS_HOST: redis-stage
      REDIS_PORT: 6379

      # OpenAI Configuration
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_API_KEY2: ${OPENAI_API_KEY2:-}
      OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}

      # VoyageAI Configuration
      VOYAGEAI_API_KEY: ${VOYAGEAI_API_KEY}
      VOYAGEAI_EMBEDDING_MODEL: ${VOYAGEAI_EMBEDDING_MODEL:-voyage-multilingual-2}

      # Dynamic model selection
      OPENAI_MODEL_QUICK: ${OPENAI_MODEL_QUICK:-gpt-5-nano}
      OPENAI_MODEL_STANDARD: ${OPENAI_MODEL_STANDARD:-gpt-5-mini}
      OPENAI_MODEL_DEEP: ${OPENAI_MODEL_DEEP:-gpt-5.1}

      # LLM Provider Strategy (OpenAI-only pipeline)
      LLM_PROVIDER_STRATEGY: ${LLM_PROVIDER_STRATEGY:-openai-first}

      # Vision/OCR credentials path (inside container)
      VISION_CREDENTIALS_PATH: /app/credentials/vision-credentials.json
      GOOGLE_APPLICATION_CREDENTIALS: /app/credentials/vision-credentials.json

      # External APIs
      ZAKONONLINE_API_TOKEN: ${ZAKONONLINE_API_TOKEN}
      ZAKONONLINE_API_TOKEN2: ${ZAKONONLINE_API_TOKEN2:-}
      FULLTEXT_STRATEGY: scrape_only

      # Scrape worker concurrency
      SCRAPE_MAX_CONCURRENT: "5"
      SCRAPE_MAX_QUEUE_DEPTH: "200"
      SCRAPE_SKIP_EMBEDDINGS: "true"

      # Security
      SECONDARY_LAYER_KEYS: ${SECONDARY_LAYER_KEYS}
      JWT_SECRET: ${JWT_SECRET}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-https://stage.legal.org.ua}

    ports:
      - "127.0.0.1:3006:3002"  # Document service - localhost only

    volumes:
      # Vision API credentials for OCR
      - ../vision-ocr-credentials.json:/app/credentials/vision-credentials.json:ro

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    restart: unless-stopped

    networks:
      - secondlayer-stage-network

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 6G
        reservations:
          cpus: '0.5'
          memory: 1G

  lexwebapp-stage:
    build:
      context: ..
      dockerfile: lexwebapp/Dockerfile
      args:
        - BUILD_ENV=staging
        - VITE_API_URL=https://legal.org.ua
        - VITE_API_KEY=${VITE_API_KEY_STAGE:-REDACTED_SL_KEY_STAGE}
        - VITE_ENABLE_SSE_STREAMING=true
        - VITE_ENABLE_ALL_MCP_TOOLS=true
        - VITE_SHOW_TOOL_SELECTOR=true
        - VITE_ENABLE_THINKING_STEPS=true
        - VITE_AUTO_EXPAND_THINKING=true
    image: lexwebapp-lexwebapp:latest
    container_name: lexwebapp-stage
    ports:
    - "127.0.0.1:8092:80"
    environment:
    - NODE_ENV=staging
    - TZ=Europe/Kiev
    networks:
    - secondlayer-stage-network
    restart: unless-stopped
    depends_on:
      - app-stage
    healthcheck:
      test:
      - CMD
      - sh
      - -c
      - wget --quiet --tries=1 --spider http://127.0.0.1/ || exit 1
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    labels:
    - com.docker.compose.project=lexwebapp-stage

  # ===== Nginx Reverse Proxy =====

  nginx-stage:
    image: nginx:alpine
    container_name: nginx-stage
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/stage.legal.org.ua.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/includes:/etc/nginx/includes:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/html:/var/www/html:ro
      - nginx_stage_logs:/var/log/nginx
    depends_on:
      app-stage:
        condition: service_healthy
      lexwebapp-stage:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nginx -t 2>/dev/null"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - secondlayer-stage-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  # ===== Monitoring Stack =====

  prometheus-stage:
    image: prom/prometheus:v2.48.0
    container_name: prometheus-stage
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_stage_data:/prometheus
    ports:
      - "127.0.0.1:9090:9090"
    networks:
      - secondlayer-stage-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M

  grafana-stage:
    image: grafana/grafana:10.2.3
    container_name: grafana-stage
    environment:
      - GF_SERVER_ROOT_URL=https://grafana.legal.org.ua
      - GF_SERVER_SERVE_FROM_SUB_PATH=false
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - PROMETHEUS_HOST=prometheus-stage
    volumes:
      - grafana_stage_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "127.0.0.1:3100:3000"
    networks:
      - secondlayer-stage-network
    restart: unless-stopped
    depends_on:
      - prometheus-stage
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  postgres-exporter-backend:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: postgres-exporter-backend-stage
    environment:
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_USER:-secondlayer}:${POSTGRES_PASSWORD}@postgres-stage:5432/${POSTGRES_DB:-secondlayer_stage}?sslmode=disable"
    ports:
      - "127.0.0.1:9187:9187"
    networks:
      - secondlayer-stage-network
    restart: unless-stopped
    depends_on:
      postgres-stage:
        condition: service_healthy

  postgres-exporter-openreyestr:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: postgres-exporter-openreyestr-stage
    environment:
      DATA_SOURCE_NAME: "postgresql://${OPENREYESTR_POSTGRES_USER:-openreyestr}:${OPENREYESTR_POSTGRES_PASSWORD}@postgres-openreyestr-stage:5432/${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}?sslmode=disable"
    ports:
      - "127.0.0.1:9188:9187"
    networks:
      - secondlayer-stage-network
    restart: unless-stopped
    depends_on:
      postgres-openreyestr-stage:
        condition: service_healthy

  redis-exporter:
    image: oliver006/redis_exporter:v1.56.0
    container_name: redis-exporter-stage
    environment:
      REDIS_ADDR: "redis://redis-stage:6379"
    ports:
      - "127.0.0.1:9121:9121"
    networks:
      - secondlayer-stage-network
    restart: unless-stopped
    depends_on:
      - redis-stage

  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: node-exporter-stage
    command:
      - '--path.rootfs=/host'
    pid: host
    volumes:
      - /:/host:ro,rslave
    networks:
      - secondlayer-stage-network
    restart: unless-stopped

  cadvisor-stage:
    image: gcr.io/cadvisor/cadvisor:v0.55.1
    container_name: cadvisor-stage
    privileged: true
    devices:
      - /dev/kmsg
    environment:
      - DOCKER_API_VERSION=1.44
    command:
      - '-docker_only=true'
      - '-housekeeping_interval=30s'
      - '-disable_metrics=cpu_topology,hugetlb,memory_numa,perf_event,referenced_memory,resctrl,sched,tcp,udp'
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
      - /etc/machine-id:/etc/machine-id:ro
    networks:
      - secondlayer-stage-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

volumes:
  postgres_stage_data:
    driver: local
  postgres_openreyestr_stage_data:
    driver: local
  qdrant_stage_data:
    driver: local
  redis_stage_data:
    driver: local
  app_stage_data:
    driver: local
  minio_stage_data:
    driver: local
  prometheus_stage_data:
    driver: local
  nginx_stage_logs:
    driver: local
  grafana_stage_data:
    driver: local
networks:
  secondlayer-stage-network:
    driver: bridge
