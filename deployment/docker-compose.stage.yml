services:
  postgres-stage:
    image: postgres:15-alpine
    container_name: secondlayer-postgres-stage
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-secondlayer}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      TZ: Europe/Kiev
    ports:
    - 5434:5432
    volumes:
    - postgres_stage_data:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER:-secondlayer} -d ${POSTGRES_DB:-secondlayer_stage}
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
    - secondlayer-stage-network

  # RADA MCP Database Initialization - creates schema and user in main DB
  rada-db-init-stage:
    image: postgres:15-alpine
    container_name: rada-db-init-stage
    depends_on:
      postgres-stage:
        condition: service_healthy
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_USER: ${POSTGRES_USER:-secondlayer}
      RADA_POSTGRES_USER: ${RADA_POSTGRES_USER:-rada_mcp}
      RADA_POSTGRES_PASSWORD: ${RADA_POSTGRES_PASSWORD}
      RADA_POSTGRES_SCHEMA: ${RADA_POSTGRES_SCHEMA:-rada}
      TZ: Europe/Kiev
    command:
      - sh
      - -lc
      - |
        echo "Initializing RADA schema/user...";
        cat <<'SQL' | psql -h "$$POSTGRES_HOST" -p "$$POSTGRES_PORT" -U "$$POSTGRES_USER" -d "$$POSTGRES_DB" \
          -v rada_user="$$RADA_POSTGRES_USER" \
          -v rada_pass="$$RADA_POSTGRES_PASSWORD" \
          -v rada_schema="$$RADA_POSTGRES_SCHEMA" \
          -v db_name="$$POSTGRES_DB"

        CREATE EXTENSION IF NOT EXISTS "pgcrypto";

        -- Create role if missing
        SELECT format('CREATE ROLE %I LOGIN PASSWORD %L', :'rada_user', :'rada_pass')
        WHERE NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = :'rada_user')\gexec

        -- Always set/refresh password (idempotent)
        SELECT format('ALTER ROLE %I WITH LOGIN PASSWORD %L', :'rada_user', :'rada_pass')\gexec

        -- Create schema if missing
        SELECT format('CREATE SCHEMA %I AUTHORIZATION %I', :'rada_schema', :'rada_user')
        WHERE NOT EXISTS (SELECT 1 FROM pg_namespace WHERE nspname = :'rada_schema')\gexec

        -- Ensure privileges
        SELECT format('GRANT USAGE, CREATE ON SCHEMA %I TO %I', :'rada_schema', :'rada_user')\gexec

        -- Ensure default search_path
        SELECT format('ALTER ROLE %I IN DATABASE %I SET search_path=%I,public', :'rada_user', :'db_name', :'rada_schema')\gexec
        SQL
    restart: "no"
    networks:
    - secondlayer-stage-network

  # OpenReyestr PostgreSQL Database
  postgres-openreyestr-stage:
    image: postgres:15-alpine
    container_name: openreyestr-postgres-stage
    environment:
      POSTGRES_USER: ${OPENREYESTR_POSTGRES_USER:-openreyestr}
      POSTGRES_PASSWORD: ${OPENREYESTR_POSTGRES_PASSWORD}
      POSTGRES_DB: ${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}
      TZ: Europe/Kiev
    ports:
      - "5436:5432"
    volumes:
      - postgres_openreyestr_stage_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${OPENREYESTR_POSTGRES_USER:-openreyestr} -d ${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - secondlayer-stage-network

  qdrant-stage:
    image: qdrant/qdrant:latest
    container_name: secondlayer-qdrant-stage
    ports:
    - 6337:6333
    - 6338:6334
    volumes:
    - qdrant_stage_data:/qdrant/storage
    restart: unless-stopped
    networks:
    - secondlayer-stage-network
    environment:
      TZ: Europe/Kiev
  redis-stage:
    image: redis:7-alpine
    container_name: secondlayer-redis-stage
    ports:
    - 6381:6379
    volumes:
    - redis_stage_data:/data
    command: redis-server --appendonly yes --maxmemory 1536mb --maxmemory-policy allkeys-lru
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    networks:
    - secondlayer-stage-network
    environment:
      TZ: Europe/Kiev
  migrate-stage:
    image: secondlayer-app:latest
    container_name: secondlayer-migrate-stage
    depends_on:
      postgres-stage:
        condition: service_healthy
      redis-stage:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-secondlayer}:${POSTGRES_PASSWORD}@postgres-stage:5432/${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-secondlayer}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NODE_ENV: staging
      TZ: Europe/Kiev
    working_dir: /app/mcp_backend
    command:
    - node
    - dist/migrations/migrate.js
    restart: 'no'
    networks:
    - secondlayer-stage-network

  # RADA MCP Migrations
  rada-migrate-stage:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.mono-rada
    image: rada-mcp:latest
    container_name: rada-mcp-migrate-stage
    depends_on:
      rada-db-init-stage:
        condition: service_completed_successfully
      redis-stage:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${RADA_POSTGRES_USER:-rada_mcp}
      POSTGRES_PASSWORD: ${RADA_POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_SCHEMA: ${RADA_POSTGRES_SCHEMA:-rada}
      REDIS_URL: redis://redis-stage:6379
      REDIS_HOST: redis-stage
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NODE_ENV: staging
      TZ: Europe/Kiev
    command: ["node", "dist/migrations/migrate.js"]
    restart: "no"
    networks:
      - secondlayer-stage-network

  # RADA MCP Application Server
  rada-mcp-app-stage:
    image: rada-mcp:latest
    container_name: rada-mcp-app-stage
    depends_on:
      rada-migrate-stage:
        condition: service_completed_successfully
      redis-stage:
        condition: service_healthy
    environment:
      NODE_ENV: staging
      PORT: 3001
      HTTP_PORT: 3001
      HTTP_HOST: 0.0.0.0
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${RADA_POSTGRES_USER:-rada_mcp}
      POSTGRES_PASSWORD: ${RADA_POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_SCHEMA: ${RADA_POSTGRES_SCHEMA:-rada}
      REDIS_URL: redis://redis-stage:6379
      REDIS_HOST: redis-stage
      REDIS_PORT: 6379
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL_QUICK: ${OPENAI_MODEL_QUICK:-gpt-4o-mini}
      OPENAI_MODEL_STANDARD: ${OPENAI_MODEL_STANDARD:-gpt-4o-mini}
      OPENAI_MODEL_DEEP: ${OPENAI_MODEL_DEEP:-gpt-4o}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_MODEL_QUICK: ${ANTHROPIC_MODEL_QUICK:-claude-haiku-4.5}
      ANTHROPIC_MODEL_STANDARD: ${ANTHROPIC_MODEL_STANDARD:-claude-sonnet-4.5}
      ANTHROPIC_MODEL_DEEP: ${ANTHROPIC_MODEL_DEEP:-claude-opus-4.5}
      LLM_PROVIDER_STRATEGY: ${LLM_PROVIDER_STRATEGY:-openai-first}
      SECONDLAYER_URL: http://app-stage:3000
      SECONDLAYER_API_KEY: ${SECONDARY_LAYER_KEYS}
      RADA_API_KEYS: ${RADA_API_KEYS}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-https://stage.legal.org.ua}
      TZ: Europe/Kiev
    # Ports removed - service accessed via unified gateway only
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - secondlayer-stage-network

  # OpenReyestr MCP Migrations
  migrate-openreyestr-stage:
    image: openreyestr-app:latest
    build:
      context: ..
      dockerfile: deployment/Dockerfile.mono-openreyestr
    container_name: openreyestr-migrate-stage
    depends_on:
      postgres-openreyestr-stage:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${OPENREYESTR_POSTGRES_USER:-openreyestr}:${OPENREYESTR_POSTGRES_PASSWORD}@postgres-openreyestr-stage:5432/${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}
      POSTGRES_HOST: postgres-openreyestr-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${OPENREYESTR_POSTGRES_USER:-openreyestr}
      POSTGRES_PASSWORD: ${OPENREYESTR_POSTGRES_PASSWORD}
      POSTGRES_DB: ${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NODE_ENV: staging
      TZ: Europe/Kiev
    command: ["node", "dist/migrations/migrate.js"]
    restart: "no"
    networks:
      - secondlayer-stage-network

  # OpenReyestr MCP Application Server
  app-openreyestr-stage:
    image: openreyestr-app:latest
    container_name: openreyestr-app-stage
    command: ["node", "dist/http-server.js"]
    environment:
      NODE_ENV: staging
      HTTP_PORT: 3005
      HTTP_HOST: 0.0.0.0
      DATABASE_URL: postgresql://${OPENREYESTR_POSTGRES_USER:-openreyestr}:${OPENREYESTR_POSTGRES_PASSWORD}@postgres-openreyestr-stage:5432/${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}
      POSTGRES_HOST: postgres-openreyestr-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${OPENREYESTR_POSTGRES_USER:-openreyestr}
      POSTGRES_PASSWORD: ${OPENREYESTR_POSTGRES_PASSWORD}
      POSTGRES_DB: ${OPENREYESTR_POSTGRES_DB:-openreyestr_stage}
      OPENREYESTR_API_KEYS: ${OPENREYESTR_API_KEYS}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL_QUICK: ${OPENAI_MODEL_QUICK:-gpt-4o-mini}
      OPENAI_MODEL_STANDARD: ${OPENAI_MODEL_STANDARD:-gpt-4o-mini}
      OPENAI_MODEL_DEEP: ${OPENAI_MODEL_DEEP:-gpt-4o}
      SECONDLAYER_URL: http://app-stage:3000
      SECONDLAYER_API_KEY: ${SECONDARY_LAYER_KEYS}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      TZ: Europe/Kiev
    # Ports removed - service accessed via unified gateway only
    depends_on:
      postgres-openreyestr-stage:
        condition: service_healthy
      migrate-openreyestr-stage:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - secondlayer-stage-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # MinIO - S3-compatible object storage for media/large files
  minio-stage:
    image: minio/minio:latest
    container_name: minio-stage
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
      TZ: Europe/Kiev
    ports:
      - "9004:9000"   # S3 API
      - "9005:9001"   # Web console
    volumes:
      - minio_stage_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - secondlayer-stage-network

  app-stage:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.mono-backend
    image: secondlayer-app:latest
    container_name: secondlayer-app-stage
    command:
    - node
    - --max-old-space-size=4096
    - dist/http-server.js
    environment:
      NODE_ENV: staging
      HTTP_PORT: ${HTTP_PORT:-3000}
      HTTP_HOST: 0.0.0.0
      JWT_SECRET: ${JWT_SECRET}
      DATABASE_URL: postgresql://${POSTGRES_USER:-secondlayer}:${POSTGRES_PASSWORD}@postgres-stage:5432/${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-secondlayer}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}
      QDRANT_URL: http://qdrant-stage:6333
      REDIS_URL: redis://redis-stage:6379
      REDIS_HOST: redis-stage
      REDIS_PORT: 6379
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_API_KEY2: ${OPENAI_API_KEY2:-}
      OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-ada-002}
      OPENAI_MODEL_QUICK: ${OPENAI_MODEL_QUICK:-gpt-4o-mini}
      OPENAI_MODEL_STANDARD: ${OPENAI_MODEL_STANDARD:-gpt-4o-mini}
      OPENAI_MODEL_DEEP: ${OPENAI_MODEL_DEEP:-gpt-4o}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_API_KEY2: ${ANTHROPIC_API_KEY2:-}
      ANTHROPIC_MODEL_QUICK: ${ANTHROPIC_MODEL_QUICK:-claude-haiku-4.5}
      ANTHROPIC_MODEL_STANDARD: ${ANTHROPIC_MODEL_STANDARD:-claude-sonnet-4.5}
      ANTHROPIC_MODEL_DEEP: ${ANTHROPIC_MODEL_DEEP:-claude-opus-4.5}
      LLM_PROVIDER_STRATEGY: ${LLM_PROVIDER_STRATEGY:-openai-first}
      ZAKONONLINE_API_TOKEN: ${ZAKONONLINE_API_TOKEN}
      ZAKONONLINE_API_TOKEN2: ${ZAKONONLINE_API_TOKEN2:-}
      SECONDARY_LAYER_KEYS: ${SECONDARY_LAYER_KEYS}

      # Unified Gateway Configuration
      ENABLE_UNIFIED_GATEWAY: "true"
      RADA_MCP_URL: http://rada-mcp-app-stage:3001
      RADA_API_KEY: ${RADA_API_KEY}
      OPENREYESTR_MCP_URL: http://app-openreyestr-stage:3005
      OPENREYESTR_API_KEY: ${OPENREYESTR_API_KEY}

      # Google Cloud Vision API (for OCR in document analysis tools)
      VISION_CREDENTIALS_PATH: /app/credentials/vision-credentials.json
      GOOGLE_APPLICATION_CREDENTIALS: /app/credentials/vision-credentials.json

      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_CALLBACK_URL: https://stage.legal.org.ua/auth/google/callback
      FRONTEND_URL: https://stage.legal.org.ua
      ALLOWED_ORIGINS: https://stage.legal.org.ua,https://stage.mcp.legal.org.ua,https://legal.org.ua
      # MinIO (S3-compatible object storage)
      MINIO_ENDPOINT: minio-stage
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_USE_SSL: "false"

      # Upload temp directory
      UPLOAD_TEMP_DIR: /app/data/uploads

      LOG_LEVEL: ${LOG_LEVEL:-info}
      TZ: Europe/Kiev
    ports:
    - 3004:3000
    depends_on:
      postgres-stage:
        condition: service_healthy
      qdrant-stage:
        condition: service_started
      redis-stage:
        condition: service_healthy
      migrate-stage:
        condition: service_completed_successfully
    volumes:
    - ../mcp_backend/logs:/app/logs
    - app_stage_data:/app/data
    # Vision API credentials for document analysis (OCR)
    - ../vision-ocr-credentials.json:/app/credentials/vision-credentials.json:ro
    healthcheck:
      test:
      - CMD
      - wget
      - --spider
      - -q
      - http://127.0.0.1:3000/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
    - secondlayer-stage-network
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 3G
        reservations:
          cpus: '0.75'
          memory: 1.5G
  # Document Analysis Service (OCR, PDF parsing)
  document-service-stage:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.document-service
    image: document-service:latest
    container_name: document-service-stage
    depends_on:
      postgres-stage:
        condition: service_healthy
      qdrant-stage:
        condition: service_started
      redis-stage:
        condition: service_healthy
    environment:
      # Application
      NODE_ENV: staging
      DOCUMENT_SERVICE_PORT: 3002
      PORT: 3002
      HTTP_PORT: 3002
      HTTP_HOST: 0.0.0.0

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-secondlayer}:${POSTGRES_PASSWORD}@postgres-stage:5432/${POSTGRES_DB:-secondlayer_stage}
      POSTGRES_HOST: postgres-stage
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-secondlayer}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-secondlayer_stage}

      # Vector DB
      QDRANT_URL: http://qdrant-stage:6333

      # Cache
      REDIS_URL: redis://redis-stage:6379
      REDIS_HOST: redis-stage
      REDIS_PORT: 6379

      # OpenAI Configuration
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_API_KEY2: ${OPENAI_API_KEY2:-}
      OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-ada-002}

      # Dynamic model selection
      OPENAI_MODEL_QUICK: ${OPENAI_MODEL_QUICK:-gpt-4o-mini}
      OPENAI_MODEL_STANDARD: ${OPENAI_MODEL_STANDARD:-gpt-4o-mini}
      OPENAI_MODEL_DEEP: ${OPENAI_MODEL_DEEP:-gpt-4o}

      # Anthropic (optional)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_API_KEY2: ${ANTHROPIC_API_KEY2:-}
      ANTHROPIC_MODEL_QUICK: ${ANTHROPIC_MODEL_QUICK:-claude-haiku-4.5}
      ANTHROPIC_MODEL_STANDARD: ${ANTHROPIC_MODEL_STANDARD:-claude-sonnet-4.5}
      ANTHROPIC_MODEL_DEEP: ${ANTHROPIC_MODEL_DEEP:-claude-opus-4.5}

      # LLM Provider Strategy
      LLM_PROVIDER_STRATEGY: ${LLM_PROVIDER_STRATEGY:-openai-first}

      # Vision/OCR credentials path (inside container)
      VISION_CREDENTIALS_PATH: /app/credentials/vision-credentials.json
      GOOGLE_APPLICATION_CREDENTIALS: /app/credentials/vision-credentials.json

      # External APIs
      ZAKONONLINE_API_TOKEN: ${ZAKONONLINE_API_TOKEN}

      # Security
      SECONDARY_LAYER_KEYS: ${SECONDARY_LAYER_KEYS}
      JWT_SECRET: ${JWT_SECRET}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-https://stage.legal.org.ua}

    ports:
      - "3005:3002"  # Expose on port 3005 externally for stage

    volumes:
      # Vision API credentials for OCR
      - ../vision-ocr-credentials.json:/app/credentials/vision-credentials.json:ro

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    restart: unless-stopped

    networks:
      - secondlayer-stage-network

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  lexwebapp-stage:
    build:
      context: ..
      dockerfile: lexwebapp/Dockerfile
      args:
        - BUILD_ENV=staging
        - VITE_API_URL=https://stage.legal.org.ua/api
        - VITE_API_KEY=${VITE_API_KEY_STAGE:-REDACTED_SL_KEY_STAGE}
        - VITE_ENABLE_SSE_STREAMING=true
        - VITE_ENABLE_ALL_MCP_TOOLS=true
        - VITE_SHOW_TOOL_SELECTOR=true
        - VITE_ENABLE_THINKING_STEPS=true
        - VITE_AUTO_EXPAND_THINKING=true
    image: lexwebapp-lexwebapp:latest
    container_name: lexwebapp-stage
    ports:
    - 8092:80
    environment:
    - NODE_ENV=staging
    - TZ=Europe/Kiev
    networks:
    - secondlayer-stage-network
    restart: unless-stopped
    depends_on:
      - app-stage
    healthcheck:
      test:
      - CMD
      - sh
      - -c
      - wget --quiet --tries=1 --spider http://127.0.0.1/ || exit 1
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    labels:
    - com.docker.compose.project=lexwebapp-stage
volumes:
  postgres_stage_data:
    driver: local
  postgres_openreyestr_stage_data:
    driver: local
  qdrant_stage_data:
    driver: local
  redis_stage_data:
    driver: local
  app_stage_data:
    driver: local
  minio_stage_data:
    driver: local
networks:
  secondlayer-stage-network:
    driver: bridge
